
# [상황: 지급인이 수취인에게 돈을 이체한다.]

## 1. 요청 접수
### 지급인의 거래은행A는 지급인으로부터 요청을 받는다.
- 송금 요청 데이터
    - 수취인의 이름
    - 수취인의 계좌 번호
    - 수취은행B의 정보 (예: 은행 코드)
    - 송금 금액
    - (선택적) 메모 또는 참조 텍스트
- 데이터 전송 시 보안
    - 데이터는 SSL/TLS와 같은 보안 프로토콜을 사용하여 암호화

## 2. 지급은행A 검증
### 지급인의 요청이 옳은지 거래은행A에서 검증
- 인증
    - 사용자가 로그인 과정을 통해 본인임을 증명한다.
    - 일반적으로 아이디와 비밀번호, 생체인식 등 다양한 방법을 통해 인증한다.
- 거래 가능성 확인
    - 해당 거래가 가능한 상태인지를 확인한다.
    - 예를 들어, 지급인 계좌에 충분한 잔액이 있는지, 계좌 상태가 정상적인지 등을 확인한다.
- 수취인 정보 형식의 확인
	- 지급은행A에서 수취인 계좌를 옳게 입력했는지 그 형식만을 검증한다.
    - 수취인의 정보 유효성 검사는 이 단계에서 이뤄지지 않는다.

## 3. 지급은행A 처리
### 지급은행A 내부 처리
- 출금 처리
    - 지급인의 계좌에서 송금 금액만큼 출금 처리
    - 은행 내부 시스템은 거래 내역을 업데이트
    - 지급인의 계좌 잔액을 감소시킴
- 거래 정보 생성
    - 송금에 필요한 거래 정보를 생성
    - 송신자와 수신자의 계좌 번호, 송금 금액, 거래 날짜 등이 포함
- 송금 요청 메시지 생성
    - 청산소로 보낼 송금 요청 메시지를 생성
    - 이 메시지는 SWIFT나 ISO 20022와 같은 국제 표준 프로토콜 형식에 따라 직렬화 및 포맷팅
- 송금 요청 전송
    - 송금 요청 메시지를 청산소로 전송
- 거래 기록 저장
    - 모든 거래 과정을 추적할 수 있도록 해당 거래에 대한 기록을 데이터베이스 등에 저장
- 응답 대기
    - 청산소 또는 수취은행B로부터 응답을 받기 위해 대기합니다.

## 3. 거래 정보 전송(지급은행A -> 청산소)
### 거래은행A는 지급인의 송금 요청을 청산소로 전달한다.
- 일반적으로 표준화된 프로토콜 및 데이터 형식을 사용
    - 국제 표준 프로토콜 및 메시지 형식
        - SWIFT(Society for Worldwide Interbank Financial Telecommunication) 또는 ISO 20022
        - 메시지에는 송신자와 수신자의 정보, 송금 금액, 거래 날짜 등 필요한 모든 정보가 포함되어 있다.
- 데이터 전송 과정
    - 직렬화(Serialization)
        - 청산소에서 생성된 송금 요청 정보는 원래의 데이터 구조(예: 객체, 구조체 등)에서 바이트 스트림으로 변환되는 과정을 거침. 이를 직렬화라고 함
        - 직렬화는 데이터를 네트워크를 통해 전송하거나 파일에 저장하기 위해 필요한 작업
    - 데이터 포맷팅
        - 직렬화된 데이터는 해당 프로토콜(SWIFT 또는 ISO 20022)의 형식에 맞게 포맷팅된다.
        - 이 과정에서 필요한 메타데이터(예: 송신자와 수신자 정보, 메시지 유형 등)가 추가된다.
    - 보안 연결 설정
        - 청산소와 은행간에 SSL/TLS와 같은 보안 프로토콜을 사용하여 안전한 연결이 설정
        - 이 보안 연결을 통해 데이터가 암호화되어 전송되므로 중간에서 데이터를 가로채도 원본 내용을 파악할 수 없음.
    - 데이터 전송
        - 보안 연결을 통해 포맷팅된 데이터가 은행으로 전송
    - 역직렬화(Deserialization)
        - 은행에서 받은 바이트 스트림을 원래의 데이터 구조로 복원하는 과정
    - 데이터 처리
        - 복원된 거래 정보가 검증 과정을 거친 후 처리

## 4. 청산소 검증
### 청산소는 지급은행A로부터 받은 정보를 검증한다.
- 거래 정보의 형식 검증
    - 청산소는 먼저 거래 정보가 올바른 형식과 프로토콜을 따르고 있는지 확인한다.
    - 예를 들어, 필요한 모든 필드가 채워져 있는지, 데이터 형식이 올바른지 등을 확인한다.
- 송금 은행의 신원 검증
    - 청산소는 송금 요청이 올바른 은행에서 왔는지 확인하기 위해 송금 은행의 신원을 검증할 수 있다.

## 5. 청산소 처리
### 청산소는 각 은행의 장부를 업데이트한다.
- 청산소는 중계자 역할을 하며, 각 은행의 장부를 정확하게 업데이트하는 책임이 있다.
- 청산소 자체 장부를 업데이트한다.
    - 장부
        - 청산소가 보유하고 있는 모든 거래 내역과 잔액 정보를 포함한 데이터베이스
        - 참여하는 모든 은행들에 대한 송금 및 입금 내역 정보가 기록되어 있음
        - 이렇게 기록된 정보를 바탕으로 일정 시간마다 검증
            - 청산소와 각 은행 사이에서 정산 과정을 진행
            - 실제 금융 거래와 데이터베이스 상의 정보가 일치하는지 확인
        - 위와 같은 일련의 과정을 통해 전체 시스템의 정확성과 일관성 유지
    - 예시
        - A 은행에서 B 은행으로 100만원을 송금하는 거래가 발생
        - 청산소의 장부에는 A 은행에서 100만원이 출금되었고 B 은행으로 100만원이 입금되었다는 내용이 기록됨

## 6. 거래 정보 전송(청산소 -> 수취은행B)
### 청산소는 송금 요청을 수취은행B로 전달한다.
- 일반적으로 표준화된 프로토콜 및 데이터 형식을 사용
    - 국제 표준 프로토콜 및 메시지 형식
        - SWIFT(Society for Worldwide Interbank Financial Telecommunication) 또는 ISO 20022
        - 메시지에는 송신자와 수신자의 정보, 송금 금액, 거래 날짜 등 필요한 모든 정보가 포함되어 있다.
- 데이터 전송 과정
    - 직렬화(Serialization)
        - 청산소에서 생성된 송금 요청 정보는 원래의 데이터 구조(예: 객체, 구조체 등)에서 바이트 스트림으로 변환되는 과정을 거침. 이를 직렬화라고 함
        - 직렬화는 데이터를 네트워크를 통해 전송하거나 파일에 저장하기 위해 필요한 작업
    - 데이터 포맷팅
        - 직렬화된 데이터는 해당 프로토콜(SWIFT 또는 ISO 20022)의 형식에 맞게 포맷팅된다.
        - 이 과정에서 필요한 메타데이터(예: 송신자와 수신자 정보, 메시지 유형 등)가 추가된다.
    - 보안 연결 설정
        - 청산소와 은행간에 SSL/TLS와 같은 보안 프로토콜을 사용하여 안전한 연결이 설정
        - 이 보안 연결을 통해 데이터가 암호화되어 전송되므로 중간에서 데이터를 가로채도 원본 내용을 파악할 수 없음.
    - 데이터 전송
        - 보안 연결을 통해 포맷팅된 데이터가 은행으로 전송
    - 역직렬화(Deserialization)
        - 은행에서 받은 바이트 스트림을 원래의 데이터 구조로 복원하는 과정
    - 데이터 처리
        - 복원된 거래 정보가 검증 과정을 거친 후 처리

## 7. 수취은행B 검증
### 수취은행B는 요청이 옳은지, 수취인은 정상인지 검증
- 거래정보의 형식 검증
    - 거래 정보가 올바른 형식과 프로토콜을 따르고 있는지 확인
    - 예를 들어, 필요한 모든 필드가 채워져 있는지, 데이터 형식이 올바른지 등
- 수취인 계좌의 유효성 검증
   - 수취인 계좌의 유효성 여부나 이름 일치 여부 등은 일반적으로 수취 은행에서 직접 처리
        - 이 정보들은 보안상의 이유로 각각의 금융기관 내부에서 관리되므로 중앙 청산소에서 직접 접근하는 것보다 개별 금융기관에서 처리하는 것이 더 안전하고 효율적임.
    - 지급은행 A의 입장에서는 청산소를 통한 '간접확인' 방법을 통해 수취인 계좌 정보의 유효성을 검사하게 되는 것임.
    - 수취인의 계좌번호가 실제로 존재하고 유효한 상태인지 확인
    - 만약 계좌번호가 잘못되었거나 해당 계좌가 정지 상태라면 거래는 실패
- 송금 금액의 유효성 검증
    - 송금 금액이 음수나 0이 아닌지, 특정 한도 이내인지 등을 확인
- 청산소 신원 검증
    - 송금 요청이 올바른 청산소에서 왔는지 확인하기 위해 청산소의 신원을 검증할 수 있음
### 입금이 불가능한 상황이 발생하면 실패로 처리
- 청산소
    - 청산소의 장부 업데이트도 취소
    - 청산소에서는 일단 해당 거래를 '보류' 상태로 변경
    - 오류 메시지를 지급은행A에게 전달
- 지급은행A
    - 지급은행A는 이 오류 메시지를 받아 지급인에게 전달
    - 송금 요청이 실패했다는 것을 알림.
- 청산소
    - 장부에서 해당 거래 기록을 취소
    - 처음에 기록했던 "지급은행A에서 출금되었고 수취은행B로 입금되었다"는 내용을 삭제하거나 반대로 작용하는 트랜잭션을 추가하여 잔액을 복원
- 재검증
    - 정기적인 정산 과정에서 청산소와 각 은행의 장부가 일치하는지 확인
    - 이때 차이가 발견되면 보정 작업이 진행

## 8. 수취은행B 처리
### 검증이 문제가 없어 거래가 정상적으로 진행되는 경우
- 입금 처리
    - 수취인의 계좌에 송금 금액만큼 입금 처리
    - 이때, 은행 내부 시스템은 거래 내역을 업데이트
    - 수취인의 계좌 잔액을 증가시킴
- 거래 기록 저장
    - 해당 거래에 대한 기록을 데이터베이스 등에 저장
    - 나중에 거래 내역 조회, 문제 해결 등을 위해 사용
- 응답 메시지 생성
    - 청산소로 보낼 응답 메시지를 생성
    - 이 메시지는 송금 요청이 성공적으로 처리되었다는 것을 알림
    - SWIFT나 ISO 20022와 같은 국제 표준 프로토콜 형식에 따라 직렬화 및 포맷팅
- 응답 전송
    - 앞서 생성된 응답 메시지를 청산소로 전송
- 수신 확인 알림
    - 필요한 경우, 수취인에게 입금 확인 알림을 보낸다.
    - 이는 SMS나 모바일 앱 푸시 알림 등 다양한 방식으로 제공될 수 있음


---

# 청산소의 차액 계산
- 청산소에서 차액을 계산한 후에는 먼저 중앙은행에 보고한다.
    - 그 이유는 중앙은행이 청산 과정에서 가장 중요한 역할을 하는 주체이기 때문이다.
    - 청산소가 계산한 차액을 기반으로 중앙은행은 각 은행의 계정에 대해 입출금 작업을 수행한다.
    - 이 과정이 완료되면 각 은행의 잔고가 최종적으로 결정된다.
- 그 후, 각 은행들에게 차액 정보와 그 결과를 통보한다.
    - 각 은행은 자신의 장부를 업데이트하고 필요한 경우 고객에게 해당 정보를 전달한다.


### [수취인 정보 확인 방법]
1. 직접 확인
    - 일부 국가에서는 은행 간에 연결된 중앙 데이터베이스 시스템을 통해 다른 은행의 계좌 존재 여부를 확인할 수 있습니다.
    - 이 경우, 송금 요청이 들어온 후 해당 시스템을 통해 실시간으로 계좌의 유효성을 검사합니다.
2. 간접 확인
    - 직접적인 연결 없이도, 청산소나 중앙은행 등 제3자 기관을 통해 계좌 정보의 유효성 검사를 진행할 수 있습니다.
    - 이 경우, 거래 요청이 청산소로 전송되면 청산소에서 받는 은행의 계좌 유효성을 검사하고 결과를 보고받습니다.
3. SWIFT 메시지 교환
    - SWIFT 네트워크를 통해 IBAN (International Bank Account Number) 등의 국제 표준화된 계좌 번호 형식을 사용하여 수신 은행에게 질의하여 해당 계좌가 존재하는지 확인할 수도 있습니다.



### SWIFT와 ISO 20022란?
### 금융 거래에서 사용되는 메시지 표준

1. SWIFT(Society for Worldwide Interbank Financial Telecommunication)
- 국제 은행 간의 통신 네트워크를 제공하는 조직
- 이 조직이 제공하는 SWIFT 메시지 형식은 전 세계 은행들 사이에서 널리 사용되고 있음.
2. ISO 20022
- 국제 표준화 기구(International Organization for Standardization)가 개발한 금융 서비스 메시징 표준
- 이 표준은 SWIFT 뿐만 아니라 다양한 금융 기관과 시스템에서 사용됩니다.
3. 한국의 경우
- 내부적으로는 KFTC가 정한 데이터 형식
- 국제 거래에서는 주로 SWIFT를 이용

> 현재 SWIFT 자체도 ISO 20022를 채택하여 그 표준을 따르는 방향으로 가고 있음. 
> 즉, 두 표준 모두 중요하며 서로 보완적인 관계에 있다고 볼 수 있음.